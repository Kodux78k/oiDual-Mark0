<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>dual.Infodose Chat ‚Äî v3 (Biblioteca de Treinos + Visual Crystal)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-dark: linear-gradient(to bottom,#000,#1a1a1a);
      --text-dark:#fff; --primary:#111; --secondary:#5e5c5e;
      --accent:#0ff; --gold:#ffd700; --success:#0f0;
      --fast:0.4s; --med:0.8s; --slow:1.8s;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;min-height:100vh}
    body{
      padding:20px;background:var(--bg-dark);color:var(--text-dark);
      font-family:'Montserrat',sans-serif;overflow:hidden;display:flex;flex-direction:column;align-items:center;
    }
    #particles-js{position:absolute;inset:0;z-index:0}
    .svg-container{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);width:160px;height:160px;z-index:1}
    .svg-container object{width:100%;height:100%}

    .top-info {
      position: fixed; top: 18px; left: 20px; z-index: 3;
      background: rgba(0,0,0,0.35); padding: 8px 12px; border-radius: 12px; font-size: 0.85em;
      backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.05);
      display: flex; gap: 15px;
    }
    .top-info span { opacity: 0.9; }

    .response-container{
      position:fixed; left:20px; right:20px; bottom:160px;
      padding:12px;background:rgba(0,0,0,0.4);backdrop-filter:blur(10px);
      border-radius:20px; max-height:calc(100vh - 220px); overflow-y:auto; -webkit-overflow-scrolling:touch; z-index:1;
    }
    .page{display:none; opacity:0; transition:opacity var(--med) ease-in-out}
    .page.active{display:block; opacity:1}
    .page.initial{text-align:center;font-size:1.1em}
    .response-controls{display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2)}
    .control-buttons{display:flex;gap:10px;align-items:center}
    .control-btn{background:rgba(255,255,255,0.05);padding:6px;border-radius:6px;cursor:pointer;transition:background var(--fast);display:flex;gap:6px;border:none;outline:none}
    .control-btn:hover{background:rgba(255,255,255,0.12)}
    .control-btn svg{stroke:rgba(255,255,255,0.5);fill:none}
    .toggle-button svg{color:#fff;stroke:rgba(255,255,255,0.3);fill:none}
    .toggle-button svg circle:nth-child(2){fill: currentColor}
    .toggle-button.active svg{color:var(--success)}
    .pagination{display:flex;align-items:center;gap:10px}
    .pagination button{background:none;border:none;font-size:1.2em;color:#6fe4fb;cursor:pointer;transition:transform var(--fast)}
    .pagination button:hover{transform:scale(1.2)}
    
    .response-block{
      margin:1rem 0;padding:1.2rem;border-radius:12px;
      animation:fadeIn var(--slow) ease forwards; transition:box-shadow var(--fast),transform var(--fast);
      line-height:1.5;position:relative;cursor:pointer;overflow:hidden;animation:pulse 6s infinite ease-in-out;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .response-block h3{margin-bottom:12px}
    .response-block:hover{box-shadow:0 0 15px rgba(0,255,255,0.12)}
    .response-block .meta { position:absolute; top:8px; right:8px; display:flex; gap:6px; z-index: 5; }
    
    .crystal-btn {
      background: rgba(0,0,0,0.4); border-radius:6px; padding:4px 8px; cursor:pointer; border:1px solid rgba(255,255,255,0.1); color:var(--accent); font-size: 1.1em;
      transition: all 0.3s;
    }
    .crystal-btn:hover { background: rgba(0,255,255,0.1); }
    .crystal-btn.saved { color: var(--gold); border-color: var(--gold); cursor: default; }

    .response-block.clicked{animation:clickPulse var(--med) ease-out}
    .response-block.expanded{transform:scale(1.03); background:rgba(0,0,0,0.85); z-index:2; border:1px solid var(--accent)}
    .intro{background:linear-gradient(135deg,rgba(0,255,255,0.08),rgba(0,100,100,0.04));border-left:4px solid #0ff}
    .middle{background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(50,50,50,0.06));border-left:4px solid rgba(255,255,255,0.2)}
    .ending{background:linear-gradient(135deg,rgba(255,0,255,0.06),rgba(100,0,100,0.04));border-left:4px solid #f0f}
    .footer-text{margin-top:12px;font-size:0.8em;text-align:center;font-style:italic}

    .input-container{position:fixed;left:20px;right:20px;bottom:90px;display:flex;gap:10px;z-index:2;max-width:calc(100% - 40px)}
    .input-container input{flex:1;padding:10px;border:none;border-radius:20px;background:rgba(255,255,255,0.1);color:inherit;outline:none;font-size:16px;transition:background var(--fast)}
    .input-container input:focus{background:rgba(255,255,255,0.2)}
    .input-container button{width:60px;height:60px;border:none;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--secondary));color:#fff;font-size:1.5em;cursor:pointer;display:flex;justify-content:center;align-items:center;animation:pulse 2s infinite ease-in-out;transition:transform var(--fast)}
    .input-container button:hover{transform:scale(1.1)}

    /* Modals & Panels */
    .modal, .panel { position: fixed; inset: 0; display: none; z-index: 9998; justify-content:center; align-items:center; backdrop-filter: blur(5px); background: rgba(0,0,0,0.6); }
    .modal.active, .panel.active { display:flex }
    .box {
      background:#1a1a1a;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);
      width:90%;max-width:600px;box-shadow:0 8px 40px rgba(0,0,0,0.8); color:#fff;
      max-height: 85vh; overflow-y: auto;
    }
    .box h3{color:var(--accent);margin-bottom:12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:8px;}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .input-group label{font-size:0.85em;color:#aaa;margin-left:4px}
    .input-group input[type="text"], .input-group input[type="password"], .input-group input[type="file"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.5);color:#fff;outline:none;
    }
    .settings-actions{display:flex;gap:10px;margin-top:12px; justify-content: flex-end;}
    .btn{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-weight:600;font-size:0.9em; transition:0.3s}
    .btn-prim{background:var(--accent);color:#000}
    .btn-prim:hover{box-shadow: 0 0 10px var(--accent)}
    .btn-sec{background:rgba(255,255,255,0.1);color:#fff}
    .btn-sec:hover{background:rgba(255,255,255,0.2)}
    .btn-danger{background:rgba(255,50,50,0.2);color:#ffaaaa}
    .btn-danger:hover{background:rgba(255,50,50,0.4)}
    .small {font-size:0.85em;color:#bbb}

    /* Training Library Styles */
    .lib-list { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
    .lib-item { 
      background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; 
      border-left: 3px solid transparent;
    }
    .lib-item.active-training { border-left-color: var(--success); background: rgba(0,255,0,0.05); }
    .lib-item-info { display: flex; flex-direction: column; }
    .lib-item-name { font-weight: bold; font-size: 0.95em; }
    .lib-item-date { font-size: 0.75em; color: #777; }
    .lib-actions { display: flex; gap: 6px; }

    .crystal-list { max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:8px }
    .crystal-item { background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.05); }
    .crystal-header { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
    .crystal-content { font-size: 0.9em; color: #ddd; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }

    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes clickPulse{0%,100%{opacity:1}50%{opacity:0.8}}
    
    @media (max-width:640px){
      .box{max-width:95%}
      .top-info { flex-direction: column; gap: 4px; }
      .svg-container{width:120px;height:120px}
    }
  
/* ---------- MANTRA UPGRADE (bloco √∫nico) ---------- */
:root{
  --mantra-min-w: 260px;
  --mantra-grad: linear-gradient(135deg, rgba(0,255,255,0.12), rgba(120,0,255,0.08));
  --mantra-glow: 0 10px 30px rgba(0,255,255,0.06);
  --mantra-text: #dcefff;
  --mantra-accent: #ffd700;
  --mantra-radius: 100px;
  --mantra-padding: 12px 28px;
  --mantra-transition: 0.55s cubic-bezier(.16,1,.3,1);
}

/* container */
#mantra-toggle{
  position: fixed !important;
  left: 50% !important;
  transform: translateX(-50%) translateY(0) !important;
  bottom: 28px !important;
  z-index: 100000 !important;
  min-width: var(--mantra-min-w) !important;
  padding: var(--mantra-padding) !important;
  border-radius: var(--mantra-radius) !important;
  display:flex; gap:12px; align-items:center; justify-content:center;
  cursor:pointer !important;
  user-select:none !important;
  -webkit-user-select:none !important;
  background: var(--mantra-grad) !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: var(--mantra-glow) !important;
  backdrop-filter: blur(10px) saturate(120%) !important;
  -webkit-backdrop-filter: blur(10px) saturate(120%) !important;
  transition: transform var(--mantra-transition), box-shadow var(--mantra-transition), background var(--mantra-transition), border-color var(--mantra-transition) !important;
  font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:var(--mantra-text) !important;
  outline: none;
}

/* small gear hint */
#mantra-hint{
  font-size:14px; opacity:0.7; align-self:center;
  margin-left:6px; display:inline-block; transform:translateY(1px);
}

/* text */
#mantra-text{
  font-size:0.86rem; color:var(--mantra-text); line-height:1; font-style:italic;
  text-align:center; white-space:nowrap; transition: all 0.35s ease;
}

/* hover / active */
#mantra-toggle:hover{ transform: translateX(-50%) translateY(-3px); box-shadow: 0 18px 45px rgba(0,255,255,0.09); border-color: rgba(255,255,255,0.14); }
#mantra-toggle:active{ transform: translateX(-50%) translateY(0); }

/* collapsed / zen */
#mantra-toggle.collapsed{
  --mantra-grad: linear-gradient(90deg, rgba(255,215,0,0.12), rgba(255,120,0,0.06));
  border-color: rgba(255,215,0,0.26);
  box-shadow: 0 0 28px rgba(255,215,0,0.08);
  padding: 10px 44px !important;
}
#mantra-toggle.collapsed #mantra-text{ font-weight:700; letter-spacing:3px; color:var(--mantra-accent); text-shadow:0 0 8px rgba(255,215,0,0.18); font-style:normal; }

/* micro-animate when long-press starts */
#mantra-toggle.longpressing{ transform: translateX(-50%) scale(0.98); box-shadow: 0 6px 24px rgba(0,0,0,0.35) inset; filter:brightness(0.98); }

/* fade animations */
.fade-out{ opacity:0; transform: translateY(6px) scale(.995); transition: all .28s ease; }
.fade-in{ opacity:1; transform: translateY(0); transition: all .28s ease; }

/* Settings panel (pops near the button) */
#mantra-settings-panel{
  position: fixed; z-index:100001; left:50%; transform:translateX(-50%); bottom:86px;
  min-width:320px; max-width:420px; width:clamp(320px,42vw,420px);
  background: linear-gradient(180deg, rgba(12,12,12,0.92), rgba(18,18,18,0.96));
  border-radius:12px; padding:12px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  display:none; flex-direction:column; gap:10px;
}
#mantra-settings-panel.active{ display:flex; animation: fadePanel .28s cubic-bezier(.2,.9,.35,1); }
@keyframes fadePanel{ from{ opacity:0; transform:translateX(-50%) translateY(10px)} to{ opacity:1; transform:translateX(-50%) translateY(0)} }

/* panel content */
.mantra-row{ display:flex; gap:8px; align-items:center; }
.mantra-col{ display:flex; flex-direction:column; gap:6px; flex:1; }
.mantra-label{ font-size:0.78rem; color:#9bb; }
.mantra-input, .mantra-select{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:#eaf6ff; padding:8px; border-radius:8px; font-size:0.9rem; outline:none }
.mantra-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:6px; }
.mantra-btn{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; font-size:0.9rem }
.mantra-btn.prim{ background:linear-gradient(90deg,#0ff,#8a2be2); color:#001; }
.mantra-btn.sec{ background:rgba(255,255,255,0.04); color:#dfe; }

/* localStorage/IndexedDB debug area */
.mantra-meta{ font-size:0.78rem; color:#9aa; max-height:160px; overflow:auto; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px dashed rgba(255,255,255,0.02) }

/* dashboard modal (full screen overlay) */
#mantra-dashboard{
  position:fixed; inset:0; display:none; z-index:100005; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8));
}
#mantra-dashboard.active{ display:flex; }
#mantra-dashboard .dash-box{ width:92%; max-width:980px; max-height:86vh; overflow:auto; border-radius:12px; padding:16px; background:linear-gradient(180deg, #0b0b0b, #121212); border:1px solid rgba(255,255,255,0.04); box-shadow:0 30px 80px rgba(0,0,0,0.7) }
.dash-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px }
.dash-list{ display:flex; flex-direction:column; gap:8px; }
.dash-item{ padding:10px; border-radius:8px; background:rgba(255,255,255,0.02); display:flex; justify-content:space-between; gap:10px; align-items:flex-start }
.dash-item .title{ font-weight:700; color:#dff; }
.dash-item .meta{ font-size:0.82rem; color:#9bb; }
.dash-actions{ display:flex; gap:8px }
.dash-actions button{ padding:6px 8px; border-radius:6px; border:none; cursor:pointer; background:rgba(255,255,255,0.04); color:#fff }

/* responsive tweak */
@media (max-width:520px){
  #mantra-settings-panel{ left:50%; transform:translateX(-50%); bottom:96px; width:92%; }
  #mantra-toggle{ min-width:220px; padding:10px 18px; }
}
</style>

  
</head>
<body>
  <div id="particles-js"><canvas class="particles-js-canvas-el"></canvas></div>

  <div class="svg-container">
    <object data="3D_logo_Dual_Infodose_9.svg" type="image/svg+xml"></object>
  </div>

  <div class="top-info" id="topInfo">
    <span id="displayUser">User: ‚Äî</span>
    <span id="displayInfodose">Infodose: ‚Äî</span>
    <span id="displayActiveTraining" style="color:var(--success); font-weight:bold; font-size:0.8em; margin-top:2px"></span>
  </div>

  <div class="response-container" id="response">
    <div class="page initial active">
      <strong>Clique no ‚óâ e diga ‚ÄúOi, Dual‚Äù.</strong><br>
      <em>Sempre √∫nico. Sempre seu.</em>
    </div>

    <div class="response-controls">
      <div class="control-buttons">
        <button class="control-btn copy-button" title="Copiar tudo">
          <svg viewBox="0 0 24 24" width="20"><circle cx="12" cy="12" r="10"></circle><rect x="6" y="6" width="12" height="12"></rect></svg>
        </button>
        <button class="control-btn paste-button" title="Colar">
          <svg viewBox="0 0 24 24" width="20"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="4" x2="12" y2="20"></line></svg>
        </button>

        <button id="toggleBtn" class="control-btn toggle-button" title="Painel Infodose & Biblioteca">
          <svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" stroke-width="2"></circle><circle cx="12" cy="12" r="3"></circle></svg>
        </button>

        <button id="crystalBtn" class="control-btn" title="Cristalizados (Mem√≥ria)">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 2l2.9 6.3L21 10l-5 3.6L17.8 21 12 17.7 6.2 21 7 13.6 2 10l6.1-1.7L12 2z"></path></svg>
        </button>

        <button id="settingsBtn" class="control-btn" title="Configura√ß√µes API">
          <svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
      </div>

      <div class="pagination">
        <button data-action="prev">‚üµ</button>
        <span id="pageIndicator">1 / 1</span>
        <button data-action="next">‚ü∂</button>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input id="userInput" type="text" placeholder="Diga: 'oi, Dual'...">
    <button id="sendBtn" title="Enviar">‚û§</button>
    <button id="voiceBtn" title="Falar">
      <object data="Reset_buttom_Dual-Infodose.svg" type="image/svg+xml" width="36" height="36" style="pointer-events: none;"></object>
    </button>
  </div>

  <div id="settingsModal" class="modal">
    <div class="box">
      <h3>Configura√ß√£o Neural (API)</h3>
      <div class="col">
        <div class="input-group">
          <label>OpenRouter API Key (SK)</label>
          <input type="password" id="apiKeyInput" placeholder="sk-or-..." autocomplete="off">
        </div>
        <div class="input-group">
          <label>Modelo AI</label>
          <input type="text" id="modelInput" placeholder="ex: meta-llama/llama-4-maverick:free">
        </div>
        <div class="settings-actions">
          <button id="cancelSettings" class="btn btn-sec">Cancelar</button>
          <button id="saveSettings" class="btn btn-prim">Salvar Conex√£o</button>
        </div>
      </div>
    </div>
  </div>

  <div id="togglePanel" class="panel">
    <div class="box">
      <h3>Painel Infodose</h3>
      
      <div style="padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1)">
        <div class="row">
          <div style="flex:1" class="col">
            <label class="small">Usu√°rio</label>
            <input type="text" id="userNameInput" placeholder="Seu nome..." />
          </div>
          <div style="flex:1" class="col">
            <label class="small">Nome da Infodose</label>
            <input type="text" id="infodoseNameInput" placeholder="Ex: World System ‚Äî Alpha" />
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:15px; align-items:center;">
          <div style="display:flex;align-items:center;gap:6px">
             <input type="checkbox" id="assistantActiveCheckbox" />
             <label for="assistantActiveCheckbox" class="small">Infodose ativa</label>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
             <input type="checkbox" id="trainingActiveCheckbox" />
             <label for="trainingActiveCheckbox" class="small">Treinamento ativo</label>
          </div>
        </div>
      </div>

      <div style="margin-top:15px;">
        <h4 style="color:#ddd; margin-bottom:8px">Biblioteca de Treinamentos (World System)</h4>
        
        <div class="col" style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px">
          <label class="small">Adicionar novo arquivo (.txt)</label>
          <div style="display:flex; gap:8px">
            <input type="file" id="trainingUpload" accept=".txt" style="flex:1" />
            <button id="importTrainingBtn" class="btn btn-prim">Importar</button>
          </div>
        </div>

        <div id="trainingLibList" class="lib-list">
          <div class="small" style="text-align:center; padding:10px">Nenhum treinamento salvo.</div>
        </div>
      </div>

      <div class="settings-actions">
        <button id="savePanelBtn" class="btn btn-prim">Salvar & Fechar</button>
        <button id="closePanelBtn" class="btn btn-sec">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="crystalModal" class="modal">
    <div class="box">
      <h3>Cristalizados (Mem√≥ria Permanente)</h3>
      <div class="row" style="margin-bottom:12px">
        <button id="exportAllCrystal" class="btn btn-prim" style="flex:1">Exportar todos (.txt)</button>
        <button id="clearAllCrystal" class="btn btn-danger" style="flex:1">Limpar tudo</button>
      </div>
      <div class="crystal-list" id="crystalList"></div>
      <div class="settings-actions">
        <button id="closeCrystal" class="btn btn-sec">Fechar</button>
      </div>
    </div>
  </div>
<div id="mantra-toggle" aria-label="Mantra toggle" role="button" tabindex="0" title="Mantra ‚Äî clique / pressione longa para ajustes">
  <span id="mantra-text">Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.</span>
  <span id="mantra-hint" aria-hidden="true">‚öôÔ∏é</span>
</div>
<script>
/* ---------- MANTRA: visual upgrade + long-press HAPTICS + settings + dashboard ---------- */
(function () {
  const MANTRA = document.getElementById('mantra-toggle');
  const TXT = document.getElementById('mantra-text');

  if (!MANTRA || !TXT) return;

  // default settings (persisted in localStorage under 'mantra_settings')
  const DEFAULTS = {
    gradient: 'linear-gradient(135deg, rgba(0,255,255,0.12), rgba(120,0,255,0.08))',
    glow: '0 10px 30px rgba(0,255,255,0.06)',
    minWidth: '260px',
    padding: '12px 28px',
    radius: '100px',
    haptics: true,
    position: 'bottom-center' // options: bottom-center, bottom-left, bottom-right
  };

  // apply saved settings
  function loadSettings() {
    try {
      const raw = localStorage.getItem('mantra_settings');
      return raw ? Object.assign({}, DEFAULTS, JSON.parse(raw)) : Object.assign({}, DEFAULTS);
    } catch (e) {
      return Object.assign({}, DEFAULTS);
    }
  }
  let settings = loadSettings();

  function saveSettings() {
    localStorage.setItem('mantra_settings', JSON.stringify(settings));
  }

  // apply CSS variables to the element
  function applyVisuals() {
    MANTRA.style.background = settings.gradient;
    MANTRA.style.boxShadow = settings.glow;
    MANTRA.style.minWidth = settings.minWidth;
    MANTRA.style.padding = settings.padding;
    MANTRA.style.borderRadius = settings.radius;
    // position
    MANTRA.style.left = '50%';
    MANTRA.style.transform = 'translateX(-50%)';
    MANTRA.style.right = 'auto';
    MANTRA.style.bottom = '28px';
    if (settings.position === 'bottom-left') {
      MANTRA.style.left = '24px';
      MANTRA.style.transform = 'none';
    } else if (settings.position === 'bottom-right') {
      MANTRA.style.left = 'auto';
      MANTRA.style.right = '24px';
      MANTRA.style.transform = 'none';
    }
  }

  applyVisuals();

  // simple haptics shim
  function haptic(pattern) {
    try {
      if (!settings.haptics) return;
      if (navigator.vibrate) {
        navigator.vibrate(pattern || 20);
      }
      // iOS Haptics not exposed via JS ‚Äî vibration works on Android/Chrome.
    } catch (e) { /* silent */ }
  }

  // basic click toggle (keeps previous behavior: collapsed -> zen)
  let collapsed = false;
  MANTRA.addEventListener('click', (ev) => {
    // avoid firing click if it was longpress (we mark it)
    if (MANTRA._suppressClick) { MANTRA._suppressClick = false; return; }

    collapsed = !collapsed;
    MANTRA.classList.toggle('collapsed', collapsed);
    document.body.classList.toggle('zen-mode', collapsed);
    swapText(collapsed ? 'USE ¬∑ TRANSFORME ¬∑ DEVOLVA' : 'Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.');
    haptic(18);
  });

  function swapText(html) {
    TXT.classList.add('fade-out');
    setTimeout(()=> {
      TXT.innerHTML = html;
      TXT.classList.remove('fade-out');
      TXT.classList.add('fade-in');
      setTimeout(()=> TXT.classList.remove('fade-in'), 320);
    }, 260);
  }

  /* ---------- LONG PRESS to open button adjustments ---------- */
  let longPressTimer = null;
  const LONG_PRESS_MS = 600;
  function startLongPress(e) {
    if (longPressTimer) clearTimeout(longPressTimer);
    MANTRA.classList.add('longpressing');
    longPressTimer = setTimeout(()=> {
      MANTRA._suppressClick = true; // prevent the click handler firing
      openSettingsPanel();
      MANTRA.classList.remove('longpressing');
      haptic([35,15,35]);
    }, LONG_PRESS_MS);
  }
  function cancelLongPress() {
    if (longPressTimer) clearTimeout(longPressTimer);
    longPressTimer = null;
    MANTRA.classList.remove('longpressing');
  }
  MANTRA.addEventListener('pointerdown', startLongPress);
  MANTRA.addEventListener('touchstart', startLongPress);
  MANTRA.addEventListener('pointerup', cancelLongPress);
  MANTRA.addEventListener('pointercancel', cancelLongPress);
  MANTRA.addEventListener('touchend', cancelLongPress);
  MANTRA.addEventListener('mouseleave', cancelLongPress);

  /* ---------- SETTINGS PANEL (created once) ---------- */
  let panel = document.getElementById('mantra-settings-panel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'mantra-settings-panel';
    panel.innerHTML = `
      <div class="mantra-row">
        <div class="mantra-col">
          <div class="mantra-label">Visual</div>
          <select id="mantra-grad-presets" class="mantra-select">
            <option value="preset-1">Ciano ‚Üí Violeta (padr√£o)</option>
            <option value="preset-2">Dourado ‚Äî Acorde Zen</option>
            <option value="preset-3">Roxo El√©trico</option>
            <option value="custom">Personalizado (usar campo abaixo)</option>
          </select>
          <input id="mantra-custom-grad" class="mantra-input" placeholder="ex: linear-gradient(90deg,#0ff,#8a2be2)" />
        </div>
      </div>

      <div class="mantra-row">
        <div class="mantra-col">
          <div class="mantra-label">Tamanho / raio</div>
          <input id="mantra-minw" class="mantra-input" placeholder="min-width (ex: 260px)" />
          <input id="mantra-radius" class="mantra-input" placeholder="border-radius (ex: 100px)" />
        </div>
        <div style="width:120px;">
          <div class="mantra-label">Posi√ß√£o</div>
          <select id="mantra-position" class="mantra-select">
            <option value="bottom-center">Centro</option>
            <option value="bottom-left">Esquerda</option>
            <option value="bottom-right">Direita</option>
          </select>
        </div>
      </div>

      <div class="mantra-row">
        <div class="mantra-col">
          <label class="mantra-label">Haptics / Vibra√ß√£o</label>
          <select id="mantra-haptics" class="mantra-select">
            <option value="true">Ativado</option>
            <option value="false">Desativado</option>
          </select>
        </div>
        <div style="width:120px;">
          <label class="mantra-label">Painel</label>
          <button id="mantra-open-dashboard" class="mantra-btn sec">Dashboard</button>
        </div>
      </div>

      <div>
        <div class="mantra-label">Configura√ß√µes detectadas (localStorage / IndexedDB)</div>
        <div id="mantra-meta" class="mantra-meta">Detectando‚Ä¶</div>
      </div>

      <div class="mantra-actions">
        <button id="mantra-reset" class="mantra-btn sec">Reset</button>
        <button id="mantra-save" class="mantra-btn prim">Salvar</button>
      </div>
    `;
    document.body.appendChild(panel);
  }

  const metaEl = panel.querySelector('#mantra-meta');
  const presetEl = panel.querySelector('#mantra-grad-presets');
  const customGradEl = panel.querySelector('#mantra-custom-grad');
  const minwEl = panel.querySelector('#mantra-minw');
  const radEl = panel.querySelector('#mantra-radius');
  const posEl = panel.querySelector('#mantra-position');
  const hapticsEl = panel.querySelector('#mantra-haptics');
  const saveBtn = panel.querySelector('#mantra-save');
  const resetBtn = panel.querySelector('#mantra-reset');
  const dashBtn = panel.querySelector('#mantra-open-dashboard');

  function openSettingsPanel() {
    // fill with current settings
    if (settings.gradient.includes('0ff') || settings.gradient.includes('#0ff')) presetEl.value = 'preset-1';
    else if (settings.gradient.includes('255,215,0') || settings.gradient.includes('ffd700')) presetEl.value = 'preset-2';
    else if (settings.gradient.includes('8a2be2') || settings.gradient.includes('purple')) presetEl.value = 'preset-3';
    else presetEl.value = 'custom';
    customGradEl.value = settings.gradient;
    minwEl.value = settings.minWidth;
    radEl.value = settings.radius;
    posEl.value = settings.position;
    hapticsEl.value = String(!!settings.haptics);

    // detect storage
    detectStorageInfo().then(info => {
      metaEl.innerHTML = info;
    }).catch(e => { metaEl.innerText = 'Erro ao detectar storage.'; });

    panel.classList.add('active');
    // close on click outside
    setTimeout(()=> {
      const outside = (ev) => {
        if (!panel.contains(ev.target) && ev.target !== MANTRA) {
          panel.classList.remove('active');
          document.removeEventListener('pointerdown', outside);
        }
      };
      document.addEventListener('pointerdown', outside);
    }, 0);
  }

  // preset handling
  presetEl.addEventListener('change', () => {
    const v = presetEl.value;
    if (v === 'preset-1') customGradEl.value = 'linear-gradient(135deg, rgba(0,255,255,0.12), rgba(120,0,255,0.08))';
    else if (v === 'preset-2') customGradEl.value = 'linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,150,40,0.06))';
    else if (v === 'preset-3') customGradEl.value = 'linear-gradient(135deg, rgba(138,43,226,0.16), rgba(58,12,160,0.06))';
    else if (v === 'custom') { /* keep custom value */ }
  });

  // save -> persist and apply
  saveBtn.addEventListener('click', () => {
    settings.gradient = customGradEl.value || DEFAULTS.gradient;
    settings.minWidth = minwEl.value || DEFAULTS.minWidth;
    settings.radius = radEl.value || DEFAULTS.radius;
    settings.position = posEl.value || DEFAULTS.position;
    settings.haptics = (hapticsEl.value === 'true');
    saveSettings();
    applyVisuals();
    panel.classList.remove('active');
    haptic(20);
    // quick visual pulse to show change
    MANTRA.animate([{ transform: 'translateX(-50%) scale(0.98)' }, { transform: 'translateX(-50%) scale(1)' }], { duration: 260, easing: 'cubic-bezier(.2,.9,.3,1)' });
  });

  resetBtn.addEventListener('click', () => {
    settings = Object.assign({}, DEFAULTS);
    saveSettings();
    applyVisuals();
    panel.classList.remove('active');
    haptic([30,10,30]);
  });

  dashBtn.addEventListener('click', () => {
    openDashboard();
  });

  /* ---------- STORAGE DETECTION ---------- */
  async function detectStorageInfo() {
    // localStorage keys (mask keys possibly sensitive)
    const lsKeys = Object.keys(localStorage).filter(k => k.startsWith('di_') || k.toLowerCase().includes('mantra') || k.toLowerCase().includes('cristal') || k.toLowerCase().includes('training') ).sort();
    const lsPreview = lsKeys.length ? lsKeys.map(k => {
      let v = localStorage.getItem(k);
      // mask API keys
      if (/key|api|sk/i.test(k)) {
        const visible = v ? v.slice(-4) : '';
        return `<div><strong>${k}</strong>: <em>‚óè‚óè‚óè‚óè${visible.length?(' ¬∑ ' + visible):''}</em></div>`;
      }
      // short preview for large content
      if (v && v.length > 220) v = v.slice(0,120) + '‚Ä¶ (' + v.length + ' chars)';
      return `<div><strong>${k}</strong>: <span style="color:#cfe">${escapeHtml(String(v))}</span></div>`;
    }).join('') : '<div>Nenhuma key relacionada encontrada no localStorage.</div>';

    // indexedDB: try to open 'di_dashboard' and list object stores and counts
    const idbInfo = await probeIndexedDB('di_dashboard').catch(e => ({ error: true }));
    let idbPreview = '';
    if (idbInfo && idbInfo.error) idbPreview = '<div>IndexedDB: n√£o dispon√≠vel ou sem dados.</div>';
    else {
      idbPreview = `<div><strong>IndexedDB</strong> ‚Äî DB: ${escapeHtml(idbInfo.name)} ¬∑ v${idbInfo.version}</div>`;
      if (idbInfo.stores && idbInfo.stores.length) {
        idbPreview += '<div style="margin-top:6px"><em>Stores:</em></div>' + idbInfo.stores.map(s => `<div>‚Ä¢ ${s.name} ‚Äî ${s.count} entradas</div>`).join('');
      } else idbPreview += '<div>Sem objectStores detectadas.</div>';
    }

    return `<div style="display:flex;gap:12px"><div style="flex:1">${lsPreview}</div><div style="width:1px;background:rgba(255,255,255,0.02)"></div><div style="flex:1">${idbPreview}</div></div>`;
  }

  // small helper
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // probe IndexedDB: open DB and get counts for known stores (conversations, settings)
  function probeIndexedDB(dbName) {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(dbName);
      let resolved = false;
      req.onerror = () => { if (!resolved) { resolved = true; reject({ error: true }); } };
      req.onsuccess = () => {
        const db = req.result;
        const stores = [];
        const txRead = db.transaction(db.objectStoreNames, 'readonly');
        const doCounts = [];
        for (let i=0;i<db.objectStoreNames.length;i++){
          const name = db.objectStoreNames[i];
          try {
            const st = txRead.objectStore(name);
            const countReq = st.count();
            doCounts.push(new Promise((res) => countReq.onsuccess = () => res({ name, count: countReq.result })));
          } catch(e) {
            doCounts.push(Promise.resolve({ name, count: '‚Äî' }));
          }
        }
        Promise.all(doCounts).then(results => {
          if (!resolved) { resolved = true; resolve({ name: db.name, version: db.version, stores: results }); db.close(); }
        }).catch(() => { if (!resolved) { resolved = true; reject({ error: true }); db.close(); }});
      };
      // If DB not exist, onsuccess still fires with version 1 but no stores
      req.onupgradeneeded = (e) => {
        // do not create stores here; just close early
      };
    });
  }

  /* ---------- DASHBOARD (multi conversas) ---------- */
  let dashOverlay = null;
  function ensureDashboardOverlay() {
    if (dashOverlay) return dashOverlay;
    dashOverlay = document.createElement('div');
    dashOverlay.id = 'mantra-dashboard';
    dashOverlay.innerHTML = `
      <div class="dash-box">
        <div class="dash-header">
          <div>
            <strong style="font-size:1.05rem">Dashboard ¬∑ Multi-Conversas</strong><div style="font-size:0.85rem;color:#9bb">Conversations stored in IndexedDB / localStorage</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="mantra-refresh-dash" class="mantra-btn sec">Atualizar</button>
            <button id="mantra-close-dash" class="mantra-btn sec">Fechar</button>
          </div>
        </div>
        <div style="display:flex;gap:12px">
          <div style="width:46%; min-width:220px">
            <div style="font-size:0.9rem;color:#9bb;margin-bottom:8px">IndexedDB: 'di_dashboard' (conversations)</div>
            <div id="dash-idb-list" class="dash-list"></div>
          </div>
          <div style="flex:1">
            <div style="font-size:0.9rem;color:#9bb;margin-bottom:8px">localStorage: keys relevantes</div>
            <div id="dash-ls-list" class="dash-list"></div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(dashOverlay);

    dashOverlay.querySelector('#mantra-close-dash').addEventListener('click', () => dashOverlay.classList.remove('active'));
    dashOverlay.querySelector('#mantra-refresh-dash').addEventListener('click', populateDashboard);
    dashOverlay.addEventListener('click', (e) => { if (e.target === dashOverlay) dashOverlay.classList.remove('active'); });
    return dashOverlay;
  }

  async function openDashboard() {
    const ov = ensureDashboardOverlay();
    ov.classList.add('active');
    await populateDashboard();
  }

  async function populateDashboard() {
    const ov = ensureDashboardOverlay();
    const idbList = ov.querySelector('#dash-idb-list');
    const lsList = ov.querySelector('#dash-ls-list');
    idbList.innerHTML = '<div class="small" style="color:#9aa">Carregando IndexedDB‚Ä¶</div>';
    lsList.innerHTML = '<div class="small" style="color:#9aa">Carregando localStorage‚Ä¶</div>';

    // list localStorage keys we care about
    const lsKeys = Object.keys(localStorage).filter(k => k.startsWith('di_') || /cristal|training|assistant|conversation/i.test(k));
    if (!lsKeys.length) {
      lsList.innerHTML = '<div class="small" style="color:#9bb">Nenhuma key relevante encontrada no localStorage.</div>';
    } else {
      lsList.innerHTML = '';
      lsKeys.forEach(k => {
        const val = localStorage.getItem(k);
        const short = (val && val.length>220) ? (val.slice(0,160)+'‚Ä¶') : (val||'');
        const item = document.createElement('div');
        item.className = 'dash-item';
        item.innerHTML = `<div><div class="title">${escapeHtml(k)}</div><div class="meta">${escapeHtml(short)}</div></div>
                          <div class="dash-actions">
                            <button data-k="${escapeHtml(k)}" class="dash-copy">Copiar</button>
                            <button data-k="${escapeHtml(k)}" class="dash-export">Export</button>
                            <button data-k="${escapeHtml(k)}" class="dash-del">Apagar</button>
                          </div>`;
        lsList.appendChild(item);
      });

      // actions
      lsList.querySelectorAll('.dash-copy').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.k;
        navigator.clipboard.writeText(localStorage.getItem(k) || '');
      }));
      lsList.querySelectorAll('.dash-export').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.k;
        const data = localStorage.getItem(k) || '';
        const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${k}_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(url);
      }));
      lsList.querySelectorAll('.dash-del').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.k;
        if (!confirm('Apagar localStorage key: ' + k + '?')) return;
        localStorage.removeItem(k);
        populateDashboard();
      }));
    }

    // IndexedDB: try to open DB and read 'conversations' store (if exists)
    try {
      const res = await openIndexedDBAll('di_dashboard', 'conversations');
      idbList.innerHTML = '';
      if (!res || !res.length) {
        idbList.innerHTML = '<div class="small" style="color:#9bb">Nenhuma conversa encontrada na IndexedDB (store: conversations).</div>';
      } else {
        res.forEach(r => {
          const item = document.createElement('div');
          item.className = 'dash-item';
          const title = r.title || ('Conversa ' + (r.id||r._id||Date.now()));
          const meta = (r.at ? new Date(r.at).toLocaleString() : '');
          const excerpt = (r.content && r.content.length>220) ? r.content.slice(0,220)+'‚Ä¶' : (r.content||'');
          item.innerHTML = `<div><div class="title">${escapeHtml(title)}</div><div class="meta">${escapeHtml(meta)}</div><div style="margin-top:6px">${escapeHtml(excerpt)}</div></div>
            <div class="dash-actions">
              <button data-id="${r.id||r._id||r.key}" class="dash-copy">Copiar</button>
              <button data-id="${r.id||r._id||r.key}" class="dash-export">Export</button>
              <button data-id="${r.id||r._id||r.key}" class="dash-del">Apagar</button>
            </div>`;
          idbList.appendChild(item);
        });

        // attach actions
        idbList.querySelectorAll('.dash-copy').forEach(b => b.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          const rec = res.find(x=>String(x.id||x._id||x.key)===String(id));
          if (rec && rec.content) await navigator.clipboard.writeText(rec.content);
        }));
        idbList.querySelectorAll('.dash-export').forEach(b => b.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          const rec = res.find(x=>String(x.id||x._id||x.key)===String(id));
          if (!rec) return;
          const blob = new Blob([rec.content || ''], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `di_conv_${id || Date.now()}.txt`; a.click(); URL.revokeObjectURL(url);
        }));
        idbList.querySelectorAll('.dash-del').forEach(b => b.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          if (!confirm('Apagar item da IndexedDB?')) return;
          await deleteIndexedDBKey('di_dashboard', 'conversations', id);
          populateDashboard();
        }));
      }
    } catch (err) {
      idbList.innerHTML = '<div class="small" style="color:#c77">Erro lendo IndexedDB.</div>';
    }
  }

  /* ---------- small IndexedDB helpers (open read all / delete) ---------- */
  function openIndexedDBAll(dbName, storeName) {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(dbName);
      req.onerror = () => resolve([]); // treat missing DB as empty
      req.onsuccess = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(storeName)) { resolve([]); db.close(); return; }
        const tx = db.transaction(storeName, 'readonly');
        const st = tx.objectStore(storeName);
        const items = [];
        st.openCursor().onsuccess = function (evt) {
          const cursor = evt.target.result;
          if (cursor) { items.push(cursor.value); cursor.continue(); }
        };
        tx.oncomplete = () => { db.close(); resolve(items); };
        tx.onerror = () => { db.close(); resolve([]); };
      };
    });
  }

  function deleteIndexedDBKey(dbName, storeName, key) {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(dbName);
      req.onerror = () => resolve(false);
      req.onsuccess = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(storeName)) { resolve(false); db.close(); return; }
        const tx = db.transaction(storeName, 'readwrite');
        const st = tx.objectStore(storeName);
        const delReq = st.delete(key);
        delReq.onsuccess = () => { db.close(); resolve(true); };
        delReq.onerror = () => { db.close(); resolve(false); };
      };
    });
  }

  /* ---------- keyboard accessibility: open panel via keyboard (long-press emulate) ---------- */
  MANTRA.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') MANTRA.click();
    if (e.key === ' ' || e.key === 'Spacebar') { e.preventDefault(); MANTRA.click(); }
    if (e.key === 'm' && (e.ctrlKey || e.metaKey)) { openSettingsPanel(); }
  });

  // expose simple API for other scripts if needed
  window.MantraUI = {
    openSettings: openSettingsPanel,
    openDashboard,
    getSettings: () => settings,
    setSettings: (s) => { settings = Object.assign({}, settings, s); saveSettings(); applyVisuals(); }
  };

  // small initial haptic on load hint (subtle)
  setTimeout(()=> { if (settings.haptics) haptic([8]); }, 900);

})();
</script>

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    /* ---------- Constantes & Estado ---------- */
    const TRAINING_FILE_DEFAULT_NAME = 'Super_Treinamento_Universal.txt';
    const API_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions';
    const TEMPERATURE = 0.2;
    
    // Configs & Persist√™ncia
    let apiKey = localStorage.getItem('di_apiKey') || '';
    let modelName = localStorage.getItem('di_modelName') || 'meta-llama/llama-4-maverick:free';
    let userName = localStorage.getItem('di_userName') || '';
    let infodoseName = localStorage.getItem('di_infodoseName') || '';
    
    // Training State
    let trainingText = localStorage.getItem('di_trainingText') || ''; // O texto ativo
    let trainingActiveName = localStorage.getItem('di_trainingActiveName') || 'Nenhum'; // Nome do ativo
    // Biblioteca: Array de {id, name, content, date}
    let trainingLibrary = JSON.parse(localStorage.getItem('di_trainingLibrary') || '[]');

    let assistantEnabled = (localStorage.getItem('di_assistantEnabled') === '1');
    let trainingActive = (localStorage.getItem('di_trainingActive') !== '0'); // default true

    let conversation = [];
    let pages = [], currentPage = 0, autoAdvance = true;
    const CRYSTAL_KEY = 'di_cristalizados';

    /* ---------- Helpers ---------- */
    const createEl = (tag, cls, html) => { 
      const e = document.createElement(tag); 
      if (cls) e.className = cls; 
      if (html) e.innerHTML = html; 
      return e; 
    };
    
    // Split inteligente de texto em blocos de 3 par√°grafos
    const splitBlocks = text => {
      if (!text || !text.trim()) return [['...','','']];
      let paras = text.split(/\n\s*\n/).filter(p=>p.trim());
      // fallback para textos sem quebras duplas
      if (paras.length === 1 && text.length > 200) {
        paras = text.match(/[^\.!\?]+[\.!\?]+/g) || [text];
        paras = paras.map(s=>s.trim());
      }
      // Se n√£o tiver divis√≠vel por 3, agrupa
      const groups = [];
      for (let i=0;i<paras.length;i+=3) {
        let chunk = paras.slice(i, i+3);
        while(chunk.length < 3) chunk.push('...'); // padding
        groups.push(chunk);
      }
      return groups;
    };

    const speakText = (txt, onend)=> {
      if (!txt) { if (onend) onend(); return; }
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'pt-BR'; u.rate = 1.0; u.pitch = 1.05;
      if (window._vozes) u.voice = window._vozes.find(v=>v.lang==='pt-BR') || window._vozes[0];
      if (onend) u.onend = onend;
      speechSynthesis.speak(u);
    };

    const updateTopInfo = () => {
      document.getElementById('displayUser').innerText = 'User: ' + (userName || '‚Äî');
      document.getElementById('displayInfodose').innerText = 'Infodose: ' + (infodoseName || '‚Äî');
      const trDisplay = document.getElementById('displayActiveTraining');
      if (trainingActive) {
         trDisplay.innerText = 'Treino: ' + trainingActiveName;
         trDisplay.style.display = 'block';
      } else {
         trDisplay.style.display = 'none';
      }
    };

    const updateToggleUI = () => {
      document.getElementById('toggleBtn').classList.toggle('active', assistantEnabled);
      document.getElementById('assistantActiveCheckbox').checked = assistantEnabled;
      document.getElementById('trainingActiveCheckbox').checked = trainingActive;
    };

    /* ---------- Renderiza√ß√£o Principal (Com verifica√ß√£o de Cristalizado) ---------- */
    const isCrystalized = (text) => {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      // Verifica se existe conte√∫do id√™ntico (simplificado)
      return list.some(item => item.content === text);
    };

    const renderPaginatedResponse = text => {
      speechSynthesis.cancel();
      autoAdvance = true;
      const respEl = document.getElementById('response');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      pages = [];
      
      const groups = splitBlocks(text);
      const controls = respEl.querySelector('.response-controls');
      const titles = ['üéÅ Recompensa Inicial','üëÅÔ∏è Explora√ß√£o e Curiosidade','‚ö° Antecipa√ß√£o Vibracional'];

      groups.forEach((tris, gi) => {
        const page = createEl('div', gi===0?'page active':'page');
        tris.forEach((body, j) => {
          const cls = j===0?'intro': j===1?'middle':'ending';
          const b = createEl('div','response-block '+cls);
          
          // Header + Content
          b.innerHTML = `<h3>${titles[j]}</h3><p>${body}</p>`;
          
          // Meta: Cristalizar
          const meta = createEl('div','meta');
          const crystalBtn = createEl('button','crystal-btn','‚ú∂');
          
          // Check state visualmente
          if (isCrystalized(body)) {
             crystalBtn.innerText = '‚úì';
             crystalBtn.classList.add('saved');
             crystalBtn.title = 'J√° cristalizado';
          } else {
             crystalBtn.title = 'Cristalizar essa mensagem';
             crystalBtn.onclick = (ev) => {
               ev.stopPropagation();
               if (crystalBtn.classList.contains('saved')) return;
               cristalizar({ title: titles[j], content: body });
               crystalBtn.innerText = '‚úì';
               crystalBtn.classList.add('saved');
             };
          }
          meta.appendChild(crystalBtn);
          b.appendChild(meta);

          // Interaction
          b.dataset.state = '';
          b.addEventListener('click', (e) => {
            // Se clicou no bot√£o meta, n√£o expande
            if(e.target.closest('.meta')) return;

            if (!b.dataset.state) {
              speechSynthesis.cancel();
              speakText(body);
              b.classList.add('clicked');
              b.dataset.state = 'spoken';
            } else {
              // Expandir -> Enviar como prompt
              b.classList.add('expanded');
              b.dataset.state = '';
              
              // Auto-enable logic
              if (!assistantEnabled) {
                assistantEnabled = true;
                localStorage.setItem('di_assistantEnabled','1');
                updateToggleUI();
              }
              
              const blockText = `${titles[j]}\n\n${body}`;
              showLoading('Pulso em Expans√£o...');
              speechSynthesis.cancel();
              speakText('Pulso em Expans√£o...');
              
              // Injeta system message se necess√°rio, sem duplicar
              prepareConversation(); 
              conversation.push({ role:'user', content: blockText });
              callAI();
            }
          });
          b.addEventListener('animationend', e => { if (e.animationName==='clickPulse') b.classList.remove('clicked'); });
          page.appendChild(b);
        });
        
        page.appendChild(createEl('p','footer-text',`<em>Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.</em>`));
        respEl.insertBefore(page, controls);
        pages.push(page);
      });

      currentPage = 0;
      document.getElementById('pageIndicator').textContent = `1 / ${pages.length}`;
      speakPage(0);
    };

    const speakPage = i => {
      const page = pages[i];
      if (!page) return;
      const body = Array.from(page.querySelectorAll('.response-block p')).map(p=>p.innerText).join(' ');
      speakText(body, () => {
        if (!autoAdvance) return;
        if (i < pages.length - 1) {
          changePage(1);
          speakPage(i+1);
        } else {
          speakText('Do seu jeito, sempre √∫nico, sempre seu.');
        }
      });
    };

    const changePage = offset => {
      const np = currentPage + offset;
      if (np<0||np>=pages.length) return;
      pages[currentPage].classList.remove('active');
      pages[np].classList.add('active');
      currentPage = np;
      document.getElementById('pageIndicator').textContent = `${currentPage+1} / ${pages.length}`;
    };

    const showLoading = msg => {
      const respEl = document.getElementById('response');
      const controls = respEl.querySelector('.response-controls');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      const page = createEl('div','page active');
      page.appendChild(createEl('p','footer-text',msg));
      respEl.insertBefore(page, controls);
      pages = [page];
      currentPage = 0;
      document.getElementById('pageIndicator').textContent = '‚Ä¶';
    };

    /* ---------- L√≥gica AI ---------- */
    // Garante que o system prompt esteja no in√≠cio se ativado
    const prepareConversation = () => {
       // Remove system prompts antigos para evitar acumulo ou usar vers√£o velha
       conversation = conversation.filter(m => m.role !== 'system');
       
       if (assistantEnabled && trainingActive && trainingText) {
          conversation.unshift({ role: 'system', content: trainingText });
       }
    };

    async function callAI() {
      if (!apiKey) {
        alert('Configure sua API Key primeiro.');
        document.getElementById('settingsModal').classList.add('active');
        return;
      }

      prepareConversation();

      const bodyObj = { model: modelName, messages: conversation, temperature: TEMPERATURE };

      try {
        const resp = await fetch(API_ENDPOINT, {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${apiKey}`, 'Content-Type':'application/json' },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) throw new Error('Status: ' + resp.status);
        const data = await resp.json();
        const answer = data.choices?.[0]?.message?.content?.trim() || 'Resposta vazia.';
        
        conversation.push({ role:'assistant', content: answer });
        renderPaginatedResponse(answer);
      } catch (err) {
        console.error(err);
        const errorMsg = 'Oscila√ß√£o no pulso (Erro API). Verifique conex√£o.';
        conversation.push({ role:'assistant', content: errorMsg });
        renderPaginatedResponse(errorMsg);
      }
    }

    async function sendMessage(){
      const respEl = document.getElementById('response');
      const initPage = respEl.querySelector('.page.initial');
      if (initPage) initPage.remove();

      const input = document.getElementById('userInput');
      const raw = input.value.trim();
      if (!raw) return;
      input.value = '';

      speechSynthesis.cancel();
      speakText('');

      const txt = raw.toLowerCase();
      // Trigger secreto
      if (txt.includes('oi dual')) {
        assistantEnabled = true;
        localStorage.setItem('di_assistantEnabled','1');
        updateToggleUI();
        showLoading('Dual Infodose ativa. Pulso enviado...');
      } else {
        showLoading('‚ö°Pulso enviado... Recebendo...');
      }

      conversation.push({ role:'user', content: raw });
      callAI();
    }

    /* ---------- Gest√£o da Biblioteca de Treinos ---------- */
    const renderTrainingLib = () => {
      const el = document.getElementById('trainingLibList');
      el.innerHTML = '';
      if (trainingLibrary.length === 0) {
        el.innerHTML = '<div class="small" style="text-align:center;padding:10px">Nenhum treinamento salvo.</div>';
        return;
      }

      trainingLibrary.forEach(item => {
        const row = createEl('div', 'lib-item');
        if (item.name === trainingActiveName && trainingActive) {
           row.classList.add('active-training');
        }

        const info = createEl('div','lib-item-info');
        info.innerHTML = `<span class="lib-item-name">${item.name}</span><span class="lib-item-date">${new Date(item.date).toLocaleDateString()}</span>`;
        
        const actions = createEl('div','lib-actions');
        
        // Bot√£o Ativar
        const btnActivate = createEl('button','btn btn-sec','Ativar');
        if (item.name === trainingActiveName) {
           btnActivate.classList.replace('btn-sec','btn-prim');
           btnActivate.innerText = 'Ativo';
        }
        btnActivate.onclick = () => activateTraining(item.id);

        // Bot√£o Exportar
        const btnExport = createEl('button','btn btn-sec','‚¨á');
        btnExport.title = "Baixar .txt";
        btnExport.onclick = () => downloadTxt(item.name + '.txt', item.content);

        // Bot√£o Excluir
        const btnDel = createEl('button','btn btn-danger','X');
        btnDel.onclick = () => deleteTraining(item.id);

        actions.appendChild(btnActivate);
        actions.appendChild(btnExport);
        actions.appendChild(btnDel);
        
        row.appendChild(info);
        row.appendChild(actions);
        el.appendChild(row);
      });
    };

    const activateTraining = (id) => {
       const item = trainingLibrary.find(t => t.id === id);
       if (!item) return;
       trainingText = item.content;
       trainingActiveName = item.name;
       trainingActive = true;
       // Salvar state
       localStorage.setItem('di_trainingText', trainingText);
       localStorage.setItem('di_trainingActiveName', trainingActiveName);
       localStorage.setItem('di_trainingActive', '1');
       
       renderTrainingLib();
       updateTopInfo();
       updateToggleUI();
       // alert(`Treinamento "${item.name}" ativado.`);
    };

    const deleteTraining = (id) => {
       if(!confirm('Excluir este treinamento da biblioteca?')) return;
       trainingLibrary = trainingLibrary.filter(t => t.id !== id);
       localStorage.setItem('di_trainingLibrary', JSON.stringify(trainingLibrary));
       
       // Se deletou o ativo, reseta
       const activeStillExists = trainingLibrary.find(t => t.name === trainingActiveName);
       if (!activeStillExists && trainingLibrary.length > 0) {
          // Ativa o primeiro da lista
          activateTraining(trainingLibrary[0].id);
       } else if (trainingLibrary.length === 0) {
          trainingText = '';
          trainingActiveName = 'Nenhum';
          localStorage.setItem('di_trainingText','');
          localStorage.setItem('di_trainingActiveName', 'Nenhum');
          updateTopInfo();
       }
       renderTrainingLib();
    };

    const addTrainingToLib = (name, content) => {
       const newItem = {
          id: Date.now(),
          name: name,
          content: content,
          date: new Date().toISOString()
       };
       trainingLibrary.push(newItem);
       localStorage.setItem('di_trainingLibrary', JSON.stringify(trainingLibrary));
       renderTrainingLib();
       // Auto activate
       activateTraining(newItem.id);
    };

    /* ---------- Gest√£o de Cristalizados ---------- */
    const cristalizar = ({ title, content }) => {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      // Evita duplicata exata
      if (list.some(i => i.content === content)) return;

      const item = {
        id: Date.now(),
        title: title,
        content: content,
        user: userName || 'An√¥nimo',
        infodose: infodoseName || 'Dual',
        at: new Date().toISOString()
      };
      list.unshift(item);
      localStorage.setItem(CRYSTAL_KEY, JSON.stringify(list));
    };

    const renderCrystalList = () => {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      const el = document.getElementById('crystalList');
      el.innerHTML = '';
      
      if (!list.length) {
        el.innerHTML = '<div class="small" style="text-align:center">Mem√≥ria vazia.</div>';
        return;
      }

      list.forEach(it => {
        const d = new Date(it.at);
        const dateStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`;
        
        const card = createEl('div','crystal-item');
        card.innerHTML = `
          <div class="crystal-header">
             <strong style="color:var(--accent)">${it.title}</strong>
             <span class="small">${dateStr}</span>
          </div>
          <div class="crystal-content">${it.content}</div>
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
             <button class="btn btn-sec" style="font-size:0.75em; padding:4px 8px" onclick="navigator.clipboard.writeText(\`${it.content.replace(/`/g,'\\`')}\`)">Copiar</button>
             <button class="btn btn-sec" style="font-size:0.75em; padding:4px 8px" onclick="downloadTxt('cristal_${it.id}.txt', \`${it.content.replace(/`/g,'\\`')}\`)">Baixar</button>
             <button class="btn btn-danger" style="font-size:0.75em; padding:4px 8px" onclick="deleteCrystal(${it.id})">Apagar</button>
          </div>
        `;
        el.appendChild(card);
      });
    };
    
    // Fun√ß√µes globais para onclick no HTML gerado
    window.downloadTxt = (filename, text) => {
       const blob = new Blob([text], { type:'text/plain;charset=utf-8' });
       const url = URL.createObjectURL(blob);
       const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    };
    window.deleteCrystal = (id) => {
       let list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
       list = list.filter(x => x.id !== id);
       localStorage.setItem(CRYSTAL_KEY, JSON.stringify(list));
       renderCrystalList();
       // Atualiza visual na thread se existir
       // (Para perfeccionismo, poderia recarregar a UI, mas vamos manter simples)
    };

    /* ---------- Inicializa√ß√£o e Eventos ---------- */
    function setupUI() {
       // Settings Modal
       const sModal = document.getElementById('settingsModal');
       document.getElementById('settingsBtn').onclick = () => {
          document.getElementById('apiKeyInput').value = apiKey;
          document.getElementById('modelInput').value = modelName;
          sModal.classList.add('active');
       };
       document.getElementById('cancelSettings').onclick = () => sModal.classList.remove('active');
       document.getElementById('saveSettings').onclick = () => {
          apiKey = document.getElementById('apiKeyInput').value.trim();
          modelName = document.getElementById('modelInput').value.trim() || modelName;
          localStorage.setItem('di_apiKey', apiKey);
          localStorage.setItem('di_modelName', modelName);
          sModal.classList.remove('active');
       };

       // Toggle/Panel Modal
       const pModal = document.getElementById('togglePanel');
       document.getElementById('toggleBtn').onclick = () => {
          document.getElementById('userNameInput').value = userName;
          document.getElementById('infodoseNameInput').value = infodoseName;
          document.getElementById('assistantActiveCheckbox').checked = assistantEnabled;
          document.getElementById('trainingActiveCheckbox').checked = trainingActive;
          renderTrainingLib();
          pModal.classList.add('active');
       };
       document.getElementById('closePanelBtn').onclick = () => pModal.classList.remove('active');
       document.getElementById('savePanelBtn').onclick = () => {
          userName = document.getElementById('userNameInput').value.trim();
          infodoseName = document.getElementById('infodoseNameInput').value.trim();
          assistantEnabled = document.getElementById('assistantActiveCheckbox').checked;
          trainingActive = document.getElementById('trainingActiveCheckbox').checked;
          
          localStorage.setItem('di_userName', userName);
          localStorage.setItem('di_infodoseName', infodoseName);
          localStorage.setItem('di_assistantEnabled', assistantEnabled?'1':'0');
          localStorage.setItem('di_trainingActive', trainingActive?'1':'0');
          
          updateTopInfo();
          updateToggleUI();
          pModal.classList.remove('active');
       };

       // Crystal Modal
       const cModal = document.getElementById('crystalModal');
       document.getElementById('crystalBtn').onclick = () => {
          renderCrystalList();
          cModal.classList.add('active');
       };
       document.getElementById('closeCrystal').onclick = () => cModal.classList.remove('active');
       
       document.getElementById('clearAllCrystal').onclick = () => {
          if(confirm('Tem certeza? Isso apaga todas as mem√≥rias salvas.')) {
             localStorage.removeItem(CRYSTAL_KEY);
             renderCrystalList();
             // Opcional: remover os checks visuais da tela atual
             document.querySelectorAll('.crystal-btn').forEach(b => {
                b.innerText='‚ú∂'; b.classList.remove('saved'); b.onclick = null; // reset simples
             });
          }
       };
       document.getElementById('exportAllCrystal').onclick = () => {
          const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
          if(!list.length) return alert('Nada para exportar.');
          const allTxt = list.map(i => `=== ${i.title} ===\nDATA: ${i.at}\nUSER: ${i.user}\nINFODOSE: ${i.infodose}\n\n${i.content}\n\n`).join('------------------\n\n');
          downloadTxt(`Backup_Cristal_${Date.now()}.txt`, allTxt);
       };

       // Import Training Logic
       document.getElementById('importTrainingBtn').onclick = () => {
          const fileIn = document.getElementById('trainingUpload');
          const file = fileIn.files[0];
          if (!file) return alert('Selecione um arquivo .txt');
          
          const saveName = prompt('D√™ um nome para esta vers√£o do treinamento (ex: V1.0):', file.name);
          if (!saveName) return;

          const reader = new FileReader();
          reader.onload = (e) => {
             addTrainingToLib(saveName, e.target.result);
             fileIn.value = ''; // reset
             alert('Treinamento salvo na biblioteca e ativado!');
          };
          reader.readAsText(file);
       };
    }

    document.addEventListener('DOMContentLoaded', () => {
      speechSynthesis.onvoiceschanged = () => { window._vozes = speechSynthesis.getVoices(); };
      
      particlesJS('particles-js',{
        particles:{ number:{value:40},color:{value:['#0ff','#f0f']}, shape:{type:'circle'},opacity:{value:0.4},size:{value:2.4}, move:{enable:true,speed:1.5} }, retina_detect:true
      });

      setupUI();
      updateTopInfo();
      updateToggleUI();

      // Inputs Chat
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('userInput').addEventListener('keypress', e => { if (e.key==='Enter') sendMessage(); });
      document.querySelector('[data-action="prev"]').addEventListener('click', () => changePage(-1));
      document.querySelector('[data-action="next"]').addEventListener('click', () => changePage(1));
      
      document.querySelector('.copy-button').addEventListener('click', () => {
        const pages = Array.from(document.querySelectorAll('.response-container .page'));
        const fullText = pages.map(p => p.innerText.trim()).join('\n\n');
        navigator.clipboard.writeText(fullText);
      });
      document.querySelector('.paste-button').addEventListener('click', async () => {
        try { document.getElementById('userInput').value = await navigator.clipboard.readText(); } catch (err) {}
      });

      // Voice
      document.getElementById('voiceBtn').addEventListener('click', ()=>{
        const R = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
        R.lang='pt-BR'; R.start();
        R.onresult = e => {
          document.getElementById('userInput').value = e.results[0][0].transcript;
          sendMessage();
        };
      });
    });
  </script>
</body>
</html>
